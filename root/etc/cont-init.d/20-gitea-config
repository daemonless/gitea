#!/bin/sh
# Initialize Gitea configuration

# Ensure directories exist and have correct permissions
mkdir -p /config/data /config/custom/conf /config/repos /config/log /config/lfs /config/tmp /config/bin
chown -R bsd:bsd /config

# Copy gitea binary to volume (workaround for Podman overlay filesystem setuid issue)
# s6-setuidgid can't exec binaries from overlay fs when dropping privileges
if [ ! -f /config/bin/gitea ] || [ /usr/local/sbin/gitea -nt /config/bin/gitea ]; then
    echo "Copying gitea binary to volume..."
    cp /usr/local/sbin/gitea /config/bin/gitea
    chmod 755 /config/bin/gitea
    chown bsd:bsd /config/bin/gitea
fi

# If no config exists, create a minimal one
if [ ! -f /config/custom/conf/app.ini ]; then
    cat > /config/custom/conf/app.ini << 'EOF'
APP_NAME = Gitea: Git with a cup of tea
RUN_USER = bsd
WORK_PATH = /config
RUN_MODE = prod

[repository]
ROOT = /config/repos

[server]
APP_DATA_PATH = /config/data
STATIC_ROOT_PATH = /usr/local/share/gitea
DOMAIN = localhost
HTTP_PORT = 3000
ROOT_URL = http://localhost:3000/
SSH_DOMAIN = %(DOMAIN)s
DISABLE_SSH = false
SSH_PORT = 22
LFS_START_SERVER = true
OFFLINE_MODE = true

[database]
PATH = /config/data/gitea.db
DB_TYPE = sqlite3

[log]
ROOT_PATH = /config/log
MODE = console,file
LEVEL = info

[security]
INSTALL_LOCK = false

[lfs]
PATH = /config/lfs

[mailer]
ENABLED = false

[cron.update_checker]
ENABLED = false
EOF
    chown bsd:bsd /config/custom/conf/app.ini
    echo "Created default app.ini - run initial setup at http://localhost:3000/"
fi
