#!/bin/sh
# Initialize Gitea configuration

# Ensure directories exist and have correct permissions
mkdir -p /gitea/data /gitea/custom/conf /gitea/repos /gitea/log /gitea/lfs /gitea/tmp /gitea/bin
chown -R bsd:bsd /gitea

# Copy gitea binary to volume (workaround for Podman overlay filesystem setuid issue)
# s6-setuidgid can't exec binaries from overlay fs when dropping privileges
if [ ! -f /gitea/bin/gitea ] || [ /usr/local/sbin/gitea -nt /gitea/bin/gitea ]; then
    echo "Copying gitea binary to volume..."
    cp /usr/local/sbin/gitea /gitea/bin/gitea
    chmod 755 /gitea/bin/gitea
    chown bsd:bsd /gitea/bin/gitea
fi

# If no config exists, create a minimal one
if [ ! -f /gitea/custom/conf/app.ini ]; then
    cat > /gitea/custom/conf/app.ini << 'EOF'
APP_NAME = Gitea: Git with a cup of tea
RUN_USER = git
WORK_PATH = /gitea
RUN_MODE = prod

[repository]
ROOT = /gitea/repos

[server]
APP_DATA_PATH = /gitea/data
DOMAIN = localhost
HTTP_PORT = 3000
ROOT_URL = http://localhost:3000/
SSH_DOMAIN = %(DOMAIN)s
DISABLE_SSH = false
SSH_PORT = 22
LFS_START_SERVER = true
OFFLINE_MODE = true

[database]
PATH = /gitea/data/gitea.db
DB_TYPE = sqlite3

[log]
ROOT_PATH = /gitea/log
MODE = console,file
LEVEL = info

[security]
INSTALL_LOCK = false

[lfs]
PATH = /gitea/lfs

[mailer]
ENABLED = false

[cron.update_checker]
ENABLED = false
EOF
    chown bsd:bsd /gitea/custom/conf/app.ini
    echo "Created default app.ini - run initial setup at http://localhost:3000/"
fi
